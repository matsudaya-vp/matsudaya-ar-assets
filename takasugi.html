<!DOCTYPE html>
<html>
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Sinsaku Takasugi Photo Frame</title>

<style>
  body { margin:0; overflow:hidden; background:#000; }

  /* スマホ画面にベタ表示 */
  #video-feed, #character-overlay {
    position:fixed; top:0; left:0; width:100%; height:100%; object-fit:cover;
    z-index:1;
  }

  #character-overlay { z-index:2; }

  #ui-container {
    position:fixed;
    /* top/bottom の値はJSで動的に設定するため、ここでは初期設定は不要 */
    /* top: 80%; または bottom: 20%; は削除/コメントアウト */
    width:100%;
    display:flex;
    justify-content:center;
    z-index:3;
  }

  #capture-button {
    /* 15vw の正円ボタンに調整 */
    width: 15vw;
    height: 15vw; /* 幅と同じにして正円にする */
    padding: 0;
    font-size: 0;
    border-radius: 50%; /* 正円にする */
    cursor:pointer;
    background: #FF0000; /* 背景を赤に */
    color: #fff; /* アイコン/テキストの色を白に変更し、視認性を向上 */
    border: 3px solid #CC0000; /* 枠線を濃い赤に */
    box-shadow:0 6px 12px rgba(0,0,0,0.3);
    /* アイコンを中央に配置するための調整 */
    display: flex;
    justify-content: center;
    align-items: center;
    /* JSで位置を正確に中央に持ってくるため、自身の高さの半分だけ上にオフセット */
    transform: translateY(-50%); 
  }

  /* ボタン内のアイコン/テキストのサイズ調整 */
  #capture-button::before {
    content: "Shot";
    font-size: 6vw; /* 15vw に収まるように調整 */
  }
</style>
</head>

<body>
<video id="video-feed" autoplay playsinline></video>
<img id="character-overlay" src="pf-takasugi2.png" alt="高杉晋作">
<div id="ui-container"><button id="capture-button">📸 撮影</button></div>

<script>
const video = document.getElementById('video-feed');
const overlay = document.getElementById('character-overlay');
const captureButton = document.getElementById('capture-button');
const uiContainer = document.getElementById('ui-container'); // ui-containerを取得

/**
 * オーバーレイ画像の下端にボタンの中央を合わせる
 * - transform: translateY(-50%) がボタンに適用されているため、
 * コンテナの上端をオーバーレイ画像の下端に設定することで、ボタンの中央が画像の下端に来る。
 */
function adjustButtonPosition() {
    // getBoundingClientRect() で要素のビューポート内の正確な位置とサイズを取得
    const overlayRect = overlay.getBoundingClientRect();
    
    // 画像の下端のY座標を取得 (これがボタンコンテナの top の基準となる)
    const overlayBottom = overlayRect.bottom;
    
    // ui-container の top スタイルを動的に設定
    // 画像の下端にコンテナの上端を合わせる
    uiContainer.style.top = `${overlayBottom}px`;

    // 補足: 
    // ボタンのCSSに transform: translateY(-50%) が適用されているため、
    // ボタンの「中心」が画像の下端 (overlayBottom) に位置します。
    // もし、ボタンの「上端」を画像の下端に合わせたい場合は、 transform: translateY(-50%) を削除してください。
}


// 背面カメラ（高解像度を希望）
navigator.mediaDevices.getUserMedia({
  video: { facingMode: "environment", width: { ideal: 2436 }, height: { ideal: 1125 } }
}).then(stream => { 
    video.srcObject = stream; 
    
    // 動画のロード完了とオーバーレイ画像の読み込み完了を待って位置を調整
    // 画像の自然な読み込みを待つ
    if (overlay.complete) {
        adjustButtonPosition();
    } else {
        overlay.addEventListener('load', adjustButtonPosition);
    }
    
}).catch(err => alert("カメラアクセスエラー: " + err));

// 画面サイズ変更時にも位置を調整（スマホの回転やツールバーの出し入れに対応）
window.addEventListener('resize', adjustButtonPosition);
window.addEventListener('orientationchange', adjustButtonPosition);


// 撮影処理（変更なし）
captureButton.addEventListener('click', () => {
  const HD_W = 1080;   // 切り出し幅
  const HD_H = 1920;   // 切り出し高さ
  const canvas = document.createElement('canvas');
  canvas.width = HD_W;
  canvas.height = HD_H;
  const ctx = canvas.getContext('2d');

  // video の中央を切り出す
  const videoRatio = video.videoWidth / video.videoHeight;
  const canvasRatio = HD_W / HD_H;

  let srcW, srcH, srcX, srcY;
  if(videoRatio > canvasRatio){
    srcH = video.videoHeight;
    srcW = srcH * canvasRatio;
    srcX = (video.videoWidth - srcW)/2;
    srcY = 0;
  } else {
    srcW = video.videoWidth;
    srcH = srcW / canvasRatio;
    srcX = 0;
    srcY = (video.videoHeight - srcH)/2;
  }
  ctx.drawImage(video, srcX, srcY, srcW, srcH, 0, 0, HD_W, HD_H);

  // キャラクター画像も中央基準で切り出す
  const imgRatio = overlay.naturalWidth / overlay.naturalHeight;
  let imgW, imgH, imgX, imgY;
  if(imgRatio > canvasRatio){
    imgH = overlay.naturalHeight;
    imgW = imgH * canvasRatio;
    imgX = (overlay.naturalWidth - imgW)/2;
    imgY = 0;
  } else {
    imgW = overlay.naturalWidth;
    imgH = imgW / canvasRatio;
    imgX = 0;
    imgY = (overlay.naturalHeight - imgH)/2;
  }
  ctx.drawImage(overlay, imgX, imgY, imgW, imgH, 0, 0, HD_W, HD_H);

  // タイムスタンプ付きファイル名
  const now = new Date();
  const timestamp = now.toISOString().replace(/[-:T]/g,"").slice(0,14);
  const link = document.createElement('a');
  link.download = `matsudaya_photo_${timestamp}.png`;
  link.href = canvas.toDataURL("image/png");
  link.click();
});
</script>
</body>
</html>