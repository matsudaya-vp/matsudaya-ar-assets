<script>
        const video = document.getElementById('video-feed');
        const captureButton = document.getElementById('capture-button');
        const characterOverlay = document.getElementById('character-overlay');

        // 1. ã‚«ãƒ¡ãƒ©æ˜ åƒã®å–å¾—ã¨é–‹å§‹
        if (navigator.mediaDevices && navigator.mediaDevices.getUserMedia) {
            navigator.mediaDevices.getUserMedia({ video: { facingMode: "environment" } }) // èƒŒé¢ã‚«ãƒ¡ãƒ©å„ªå…ˆ
                .then(stream => {
                    video.srcObject = stream;
                })
                .catch(err => {
                    alert('ã‚«ãƒ¡ãƒ©ã¸ã®ã‚¢ã‚¯ã‚»ã‚¹ãŒæ‹’å¦ã•ã‚Œã¾ã—ãŸ: ' + err);
                });
        }
        
        // 2. æ’®å½±æ©Ÿèƒ½ã®å®Ÿè£…ï¼ˆã‚«ãƒ¡ãƒ©æ˜ åƒã¨ã‚­ãƒ£ãƒ©ã‚¯ã‚¿ãƒ¼ç”»åƒã‚’åˆæˆï¼‰
        captureButton.addEventListener('click', () => {
            // ã‚«ãƒ¡ãƒ©æ˜ åƒã®å¹…ã¨é«˜ã•ã‚’å–å¾—
            const w = video.videoWidth;
            const h = video.videoHeight;

            // åˆæˆç”¨ã®ã‚­ãƒ£ãƒ³ãƒã‚¹ã‚’ä½œæˆ
            const canvas = document.createElement('canvas');
            canvas.width = w;
            canvas.height = h;
            const context = canvas.getContext('2d');

            // 1. ã‚«ãƒ¡ãƒ©æ˜ åƒã‚’ã‚­ãƒ£ãƒ³ãƒã‚¹ã«æç”» (CSSã®åè»¢ã‚’è€ƒæ…®)
            context.save();
            context.scale(-1, 1);
            context.drawImage(video, -w, 0, w, h);
            context.restore();

            // 2. ã‚­ãƒ£ãƒ©ã‚¯ã‚¿ãƒ¼ç”»åƒã‚’ã‚­ãƒ£ãƒ³ãƒã‚¹ã«æç”»
            // ã‚­ãƒ£ãƒ©ã‚¯ã‚¿ãƒ¼ã®ä½ç½®ã¨ã‚µã‚¤ã‚ºã‚’è¨ˆç®—ã—ã¦æ­£ç¢ºã«é‡ã­ã‚‹
            const img = characterOverlay;
            const imgRatio = img.naturalHeight / img.naturalWidth;
            const screenRatio = window.innerHeight / window.innerWidth;

            let finalW, finalH;

            // ã‚­ãƒ£ãƒ©ã‚¯ã‚¿ãƒ¼ãŒç”»é¢å¹…70%ã®ã‚µã‚¤ã‚ºï¼ˆCSSè¨­å®šï¼‰ã«ãªã‚‹ã‚ˆã†ã«è¨ˆç®—
            const cssVW = 0.7; // CSSã® width: 70vw; ã«å¯¾å¿œ
            finalW = w * cssVW;
            finalH = finalW * imgRatio;
            
            // ä¸­å¤®ã«æç”»
            const finalX = (w - finalW) / 2;
            const finalY = (h - finalH) / 2;
            
            context.drawImage(img, finalX, finalY, finalW, finalH);

            // 3. ç”»åƒã‚’ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰
            const dataURL = canvas.toDataURL('image/png');
            const link = document.createElement('a');
            
            // ğŸŒŸğŸŒŸğŸŒŸ ä¿®æ­£ç®‡æ‰€: ãƒ•ã‚¡ã‚¤ãƒ«åã«ç¾åœ¨ã®ã‚¿ã‚¤ãƒ ã‚¹ã‚¿ãƒ³ãƒ—ã‚’è¿½åŠ  ğŸŒŸğŸŒŸğŸŒŸ
            const timestamp = new Date().getTime();
            link.download = 'matsudaya_takasugi_' + timestamp + '.png'; 
            
            link.href = dataURL;
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
        });
    </script>