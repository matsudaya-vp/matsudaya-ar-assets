<!DOCTYPE html>
<html>
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Sinsaku Takasugi Photo Frame</title>

<style>
  body { margin:0; overflow:hidden; background:#000; }

  /* ã‚¹ãƒãƒ›ç”»é¢ã«ãƒ™ã‚¿è¡¨ç¤º */
  #video-feed, #character-overlay {
    position:fixed; top:0; left:0; width:100%; height:100%; object-fit:cover;
    z-index:1;
  }

  #character-overlay { z-index:2; }

  #ui-container {
    position:fixed;
    /* top/bottom ã®å€¤ã¯JSã§å‹•çš„ã«è¨­å®šã™ã‚‹ãŸã‚ã€ã“ã“ã§ã¯åˆæœŸè¨­å®šã¯ä¸è¦ */
    /* top: 80%; ã¾ãŸã¯ bottom: 20%; ã¯å‰Šé™¤/ã‚³ãƒ¡ãƒ³ãƒˆã‚¢ã‚¦ãƒˆ */
    width:100%;
    display:flex;
    justify-content:center;
    z-index:3;
  }

  #capture-button {
    /* 15vw ã®æ­£å††ãƒœã‚¿ãƒ³ã«èª¿æ•´ */
    width: 15vw;
    height: 15vw; /* å¹…ã¨åŒã˜ã«ã—ã¦æ­£å††ã«ã™ã‚‹ */
    padding: 0;
    font-size: 0;
    border-radius: 50%; /* æ­£å††ã«ã™ã‚‹ */
    cursor:pointer;
    background: #FF0000; /* èƒŒæ™¯ã‚’èµ¤ã« */
    color: #fff; /* ã‚¢ã‚¤ã‚³ãƒ³/ãƒ†ã‚­ã‚¹ãƒˆã®è‰²ã‚’ç™½ã«å¤‰æ›´ã—ã€è¦–èªæ€§ã‚’å‘ä¸Š */
    border: 3px solid #CC0000; /* æ ç·šã‚’æ¿ƒã„èµ¤ã« */
    box-shadow:0 6px 12px rgba(0,0,0,0.3);
    /* ã‚¢ã‚¤ã‚³ãƒ³ã‚’ä¸­å¤®ã«é…ç½®ã™ã‚‹ãŸã‚ã®èª¿æ•´ */
    display: flex;
    justify-content: center;
    align-items: center;
    /* JSã§ä½ç½®ã‚’æ­£ç¢ºã«ä¸­å¤®ã«æŒã£ã¦ãã‚‹ãŸã‚ã€è‡ªèº«ã®é«˜ã•ã®åŠåˆ†ã ã‘ä¸Šã«ã‚ªãƒ•ã‚»ãƒƒãƒˆ */
    transform: translateY(-50%); 
  }

  /* ãƒœã‚¿ãƒ³å†…ã®ã‚¢ã‚¤ã‚³ãƒ³/ãƒ†ã‚­ã‚¹ãƒˆã®ã‚µã‚¤ã‚ºèª¿æ•´ */
  #capture-button::before {
    content: "Shot";
    font-size: 6vw; /* 15vw ã«åã¾ã‚‹ã‚ˆã†ã«èª¿æ•´ */
  }
</style>
</head>

<body>
<video id="video-feed" autoplay playsinline></video>
<img id="character-overlay" src="pf-takasugi2.png" alt="é«˜æ‰æ™‹ä½œ">
<div id="ui-container"><button id="capture-button">ğŸ“¸ æ’®å½±</button></div>

<script>
const video = document.getElementById('video-feed');
const overlay = document.getElementById('character-overlay');
const captureButton = document.getElementById('capture-button');
const uiContainer = document.getElementById('ui-container'); // ui-containerã‚’å–å¾—

/**
 * ã‚ªãƒ¼ãƒãƒ¼ãƒ¬ã‚¤ç”»åƒã®ä¸‹ç«¯ã«ãƒœã‚¿ãƒ³ã®ä¸­å¤®ã‚’åˆã‚ã›ã‚‹
 * - transform: translateY(-50%) ãŒãƒœã‚¿ãƒ³ã«é©ç”¨ã•ã‚Œã¦ã„ã‚‹ãŸã‚ã€
 * ã‚³ãƒ³ãƒ†ãƒŠã®ä¸Šç«¯ã‚’ã‚ªãƒ¼ãƒãƒ¼ãƒ¬ã‚¤ç”»åƒã®ä¸‹ç«¯ã«è¨­å®šã™ã‚‹ã“ã¨ã§ã€ãƒœã‚¿ãƒ³ã®ä¸­å¤®ãŒç”»åƒã®ä¸‹ç«¯ã«æ¥ã‚‹ã€‚
 */
function adjustButtonPosition() {
    // getBoundingClientRect() ã§è¦ç´ ã®ãƒ“ãƒ¥ãƒ¼ãƒãƒ¼ãƒˆå†…ã®æ­£ç¢ºãªä½ç½®ã¨ã‚µã‚¤ã‚ºã‚’å–å¾—
    const overlayRect = overlay.getBoundingClientRect();
    
    // ç”»åƒã®ä¸‹ç«¯ã®Yåº§æ¨™ã‚’å–å¾— (ã“ã‚ŒãŒãƒœã‚¿ãƒ³ã‚³ãƒ³ãƒ†ãƒŠã® top ã®åŸºæº–ã¨ãªã‚‹)
    const overlayBottom = overlayRect.bottom;
    
    // ui-container ã® top ã‚¹ã‚¿ã‚¤ãƒ«ã‚’å‹•çš„ã«è¨­å®š
    // ç”»åƒã®ä¸‹ç«¯ã«ã‚³ãƒ³ãƒ†ãƒŠã®ä¸Šç«¯ã‚’åˆã‚ã›ã‚‹
    uiContainer.style.top = `${overlayBottom}px`;

    // è£œè¶³: 
    // ãƒœã‚¿ãƒ³ã®CSSã« transform: translateY(-50%) ãŒé©ç”¨ã•ã‚Œã¦ã„ã‚‹ãŸã‚ã€
    // ãƒœã‚¿ãƒ³ã®ã€Œä¸­å¿ƒã€ãŒç”»åƒã®ä¸‹ç«¯ (overlayBottom) ã«ä½ç½®ã—ã¾ã™ã€‚
    // ã‚‚ã—ã€ãƒœã‚¿ãƒ³ã®ã€Œä¸Šç«¯ã€ã‚’ç”»åƒã®ä¸‹ç«¯ã«åˆã‚ã›ãŸã„å ´åˆã¯ã€ transform: translateY(-50%) ã‚’å‰Šé™¤ã—ã¦ãã ã•ã„ã€‚
}


// èƒŒé¢ã‚«ãƒ¡ãƒ©ï¼ˆé«˜è§£åƒåº¦ã‚’å¸Œæœ›ï¼‰
navigator.mediaDevices.getUserMedia({
  video: { facingMode: "environment", width: { ideal: 2436 }, height: { ideal: 1125 } }
}).then(stream => { 
    video.srcObject = stream; 
    
    // å‹•ç”»ã®ãƒ­ãƒ¼ãƒ‰å®Œäº†ã¨ã‚ªãƒ¼ãƒãƒ¼ãƒ¬ã‚¤ç”»åƒã®èª­ã¿è¾¼ã¿å®Œäº†ã‚’å¾…ã£ã¦ä½ç½®ã‚’èª¿æ•´
    // ç”»åƒã®è‡ªç„¶ãªèª­ã¿è¾¼ã¿ã‚’å¾…ã¤
    if (overlay.complete) {
        adjustButtonPosition();
    } else {
        overlay.addEventListener('load', adjustButtonPosition);
    }
    
}).catch(err => alert("ã‚«ãƒ¡ãƒ©ã‚¢ã‚¯ã‚»ã‚¹ã‚¨ãƒ©ãƒ¼: " + err));

// ç”»é¢ã‚µã‚¤ã‚ºå¤‰æ›´æ™‚ã«ã‚‚ä½ç½®ã‚’èª¿æ•´ï¼ˆã‚¹ãƒãƒ›ã®å›è»¢ã‚„ãƒ„ãƒ¼ãƒ«ãƒãƒ¼ã®å‡ºã—å…¥ã‚Œã«å¯¾å¿œï¼‰
window.addEventListener('resize', adjustButtonPosition);
window.addEventListener('orientationchange', adjustButtonPosition);


// æ’®å½±å‡¦ç†ï¼ˆå¤‰æ›´ãªã—ï¼‰
captureButton.addEventListener('click', () => {
  const HD_W = 1080;Â  Â // åˆ‡ã‚Šå‡ºã—å¹…
  const HD_H = 1920;Â  Â // åˆ‡ã‚Šå‡ºã—é«˜ã•
  const canvas = document.createElement('canvas');
  canvas.width = HD_W;
  canvas.height = HD_H;
  const ctx = canvas.getContext('2d');

  // video ã®ä¸­å¤®ã‚’åˆ‡ã‚Šå‡ºã™
  const videoRatio = video.videoWidth / video.videoHeight;
  const canvasRatio = HD_W / HD_H;

  let srcW, srcH, srcX, srcY;
  if(videoRatio > canvasRatio){
    srcH = video.videoHeight;
    srcW = srcH * canvasRatio;
    srcX = (video.videoWidth - srcW)/2;
    srcY = 0;
  } else {
    srcW = video.videoWidth;
    srcH = srcW / canvasRatio;
    srcX = 0;
    srcY = (video.videoHeight - srcH)/2;
  }
  ctx.drawImage(video, srcX, srcY, srcW, srcH, 0, 0, HD_W, HD_H);

  // ã‚­ãƒ£ãƒ©ã‚¯ã‚¿ãƒ¼ç”»åƒã‚‚ä¸­å¤®åŸºæº–ã§åˆ‡ã‚Šå‡ºã™
  const imgRatio = overlay.naturalWidth / overlay.naturalHeight;
  let imgW, imgH, imgX, imgY;
  if(imgRatio > canvasRatio){
    imgH = overlay.naturalHeight;
    imgW = imgH * canvasRatio;
    imgX = (overlay.naturalWidth - imgW)/2;
    imgY = 0;
  } else {
    imgW = overlay.naturalWidth;
    imgH = imgW / canvasRatio;
    imgX = 0;
    imgY = (overlay.naturalHeight - imgH)/2;
  }
  ctx.drawImage(overlay, imgX, imgY, imgW, imgH, 0, 0, HD_W, HD_H);

  // ã‚¿ã‚¤ãƒ ã‚¹ã‚¿ãƒ³ãƒ—ä»˜ããƒ•ã‚¡ã‚¤ãƒ«å
  const now = new Date();
  const timestamp = now.toISOString().replace(/[-:T]/g,"").slice(0,14);
  const link = document.createElement('a');
  link.download = `matsudaya_photo_${timestamp}.png`;
  link.href = canvas.toDataURL("image/png");
  link.click();
});
</script>
</body>
</html>