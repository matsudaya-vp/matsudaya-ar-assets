<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, viewport-fit=cover">
    <title>ARフォト撮影</title>
    <style>
        /* 全体の初期設定と安全領域対応 */
        html, body {
            margin: 0;
            padding: 0;
            width: 100%;
            height: 100%;
            overflow: hidden;
            background-color: #000;
        }

        /* メインコンテナ：画面全体にフィット */
        .ar-container {
            position: relative;
            width: 100vw;
            height: 100vh;
            display: flex;
            justify-content: center;
            align-items: center;
        }

        /* 映像要素：画面いっぱいに表示（上下切れてもOK） */
        #video-feed {
            position: absolute;
            top: 50%;
            left: 50%;
            min-width: 100%;
            min-height: 100%;
            width: auto;
            height: auto;
            transform: translate(-50%, -50%);
            object-fit: cover; /* 画面にフィット（はみ出しOK） */
            display: none; /* 初期は非表示（読み込み完了後に表示） */
        }

        /* キャラクター画像コンテナ */
        .overlay-container {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            display: flex;
            justify-content: center;
            align-items: center;
            pointer-events: none; /* 下の要素（カメラ映像）をクリックできるように */
        }

        /* キャラクター画像 */
        #character-image {
            max-width: 90vw; /* スマホ画面の幅を基準に合わせる（少し余白を持たせても良い） */
            max-height: 90vh; /* 縦長画像対応のため高さも制限 */
            width: auto;
            height: auto;
            object-fit: contain; /* 縦横比維持 */
        }

        /* UIコンテナ：画面下部に固定、安全領域対応 */
        .ui-container {
            position: fixed;
            bottom: 0;
            left: 0;
            width: 100%;
            padding-bottom: constant(safe-area-inset-bottom); /* iOS対応 (旧形式) */
            padding-bottom: env(safe-area-inset-bottom); /* iOS/Android対応 (推奨) */
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 10;
            padding-top: 20px;
            background: linear-gradient(to top, rgba(0,0,0,0.7), rgba(0,0,0,0)); /* グラデーションで下部UIを見やすく */
        }

        /* 撮影ボタン：クロスブラウザで一貫したサイズと位置 (vw単位で統一) */
        #capture-button {
            width: 15vw; /* 画面幅の15% */
            height: 15vw; /* 画面幅の15% (正円維持のため) */
            border-radius: 50%;
            background-color: white;
            border: 5px solid rgba(255, 255, 255, 0.5);
            cursor: pointer;
            box-shadow: 0 0 10px rgba(0, 0, 0, 0.5);
            transition: background-color 0.2s;
            position: relative; /* 中央配置を維持 */
        }

        #capture-button:active {
            background-color: #ddd;
        }

        /* ローディングインジケータ */
        .loading-overlay {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.8);
            color: white;
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 20;
            font-size: 1.2em;
        }

        /* カメラ非対応/エラーメッセージ */
        .error-message {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            color: white;
            padding: 20px;
            background-color: rgba(255, 0, 0, 0.7);
            border-radius: 8px;
            z-index: 30;
            text-align: center;
            display: none;
        }

        /* Canvas要素は非表示 */
        #capture-canvas {
            display: none;
        }
    </style>
</head>
<body>

    <div class="ar-container">
        <video id="video-feed" playsinline autoplay muted></video>

        <div class="overlay-container">
            <img id="character-image" src="pf-takasugi2.png" alt="キャラクター" crossorigin="anonymous">
        </div>

        <div class="ui-container">
            <button id="capture-button" aria-label="撮影"></button>
        </div>

        <div id="loading-overlay" class="loading-overlay">カメラを起動中...</div>

        <div id="error-message" class="error-message"></div>

        <canvas id="capture-canvas"></canvas>
    </div>

    <script>
        const video = document.getElementById('video-feed');
        const characterImage = document.getElementById('character-image');
        const captureButton = document.getElementById('capture-button');
        const canvas = document.getElementById('capture-canvas');
        const loadingOverlay = document.getElementById('loading-overlay');
        const errorMessage = document.getElementById('error-message');
        const ctx = canvas.getContext('2d');

        // 撮影画像の設定 (フルHD)
        const CAPTURE_WIDTH = 1920;
        const CAPTURE_HEIGHT = 1080;

        /**
         * 1. カメラ映像の開始
         */
        async function startCamera() {
            try {
                // 背面カメラを優先 (environment)
                const constraints = {
                    video: {
                        facingMode: { exact: 'environment' }, // 背面カメラ指定
                        width: { ideal: CAPTURE_WIDTH },
                        height: { ideal: CAPTURE_HEIGHT }
                    }
                };

                // カメラアクセス許可
                const stream = await navigator.mediaDevices.getUserMedia(constraints);
                video.srcObject = stream;

                video.onloadedmetadata = () => {
                    video.play();
                    loadingOverlay.style.display = 'none';
                    video.style.display = 'block';
                    captureButton.disabled = false;
                };

            } catch (err) {
                console.error("カメラへのアクセスでエラーが発生しました:", err);
                loadingOverlay.style.display = 'none';
                errorMessage.style.display = 'block';
                errorMessage.textContent = 'カメラへのアクセスが許可されていません。設定を確認するか、対応ブラウザでアクセスしてください。エラー: ' + err.name;
                captureButton.disabled = true;
            }
        }

        /**
         * 2. 撮影処理とダウンロード
         */
        captureButton.addEventListener('click', () => {
            captureButton.disabled = true;
            loadingOverlay.style.display = 'flex';
            
            // Canvasを撮影画像のフルHDサイズに設定
            canvas.width = CAPTURE_WIDTH;
            canvas.height = CAPTURE_HEIGHT;

            // 撮影の実行
            drawFrame();
        });

        /**
         * 3. 画像合成ロジック (カメラ映像 + キャラクター画像)
         */
        function drawFrame() {
            // カメラ映像の縦横比
            const videoRatio = video.videoWidth / video.videoHeight;
            // 撮影画像（Canvas）の縦横比 (1920/1080)
            const captureRatio = CAPTURE_WIDTH / CAPTURE_HEIGHT;

            let sx, sy, sWidth, sHeight; // カメラ映像からの切り出し位置とサイズ

            // 6. 撮影画像は画面中央を基準に切り出し (フルHD: 1920x1080)
            if (videoRatio > captureRatio) {
                // カメラ映像の方が横長の場合 (左右が余る)
                sHeight = video.videoHeight;
                sWidth = video.videoHeight * captureRatio;
                sx = (video.videoWidth - sWidth) / 2; // 左右を均等に切り捨て
                sy = 0;
            } else {
                // カメラ映像の方が縦長の場合 (上下が余る)
                sWidth = video.videoWidth;
                sHeight = video.videoWidth / captureRatio;
                sx = 0;
                sy = (video.videoHeight - sHeight) / 2; // 上下を均等に切り捨て
            }

            // 映像をCanvasに描画 (中央を1920x1080で切り出し)
            ctx.drawImage(video, sx, sy, sWidth, sHeight, 0, 0, CAPTURE_WIDTH, CAPTURE_HEIGHT);

            // キャラクター画像をCanvas中央に描画
            const charNaturalWidth = characterImage.naturalWidth;
            const charNaturalHeight = characterImage.naturalHeight;
            const charRatio = charNaturalWidth / charNaturalHeight;

            // キャラクター画像の表示サイズを計算 (撮影画像の幅の約90%を最大サイズとして、縦横比を維持)
            const MAX_CHAR_WIDTH_ON_CANVAS = CAPTURE_WIDTH * 0.9;
            const MAX_CHAR_HEIGHT_ON_CANVAS = CAPTURE_HEIGHT * 0.9;
            
            let charDrawWidth, charDrawHeight;

            // 縦横比を維持しつつ、最大サイズに収まるように調整
            if (charNaturalWidth / charNaturalHeight > MAX_CHAR_WIDTH_ON_CANVAS / MAX_CHAR_HEIGHT_ON_CANVAS) {
                // 画像が横長または幅が最大を超える場合、幅基準
                charDrawWidth = MAX_CHAR_WIDTH_ON_CANVAS;
                charDrawHeight = charDrawWidth / charRatio;
            } else {
                // 画像が縦長または高さが最大を超える場合、高さ基準
                charDrawHeight = MAX_CHAR_HEIGHT_ON_CANVAS;
                charDrawWidth = charDrawHeight * charRatio;
            }

            // Canvas中央に配置
            const charX = (CAPTURE_WIDTH - charDrawWidth) / 2;
            const charY = (CAPTURE_HEIGHT - charDrawHeight) / 2;

            // 画像をCanvasに描画
            ctx.drawImage(characterImage, charX, charY, charDrawWidth, charDrawHeight);

            // ダウンロード
            downloadImage();
        }

        /**
         * 4. 画像のダウンロード
         */
        function downloadImage() {
            canvas.toBlob((blob) => {
                const url = URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = generateFileName();
                document.body.appendChild(a);
                a.click();
                document.body.removeChild(a);
                URL.revokeObjectURL(url);
                
                loadingOverlay.style.display = 'none';
                captureButton.disabled = false;
            }, 'image/png'); // PNG形式で保存
        }

        /**
         * 5. タイムスタンプ付きファイル名生成
         */
        function generateFileName() {
            const now = new Date();
            const year = now.getFullYear();
            const month = String(now.getMonth() + 1).padStart(2, '0');
            const day = String(now.getDate()).padStart(2, '0');
            const hour = String(now.getHours()).padStart(2, '0');
            const minute = String(now.getMinutes()).padStart(2, '0');
            const second = String(now.getSeconds()).padStart(2, '0');

            // 形式: yyyy-mm-dd HH-MM-SS.png
            return `${year}-${month}-${day} ${hour}-${minute}-${second}.png`;
        }

        // ページロード時にカメラを起動
        window.onload = () => {
            // キャラクター画像がまだロードされていない場合は待機
            if (!characterImage.complete) {
                characterImage.onload = startCamera;
                characterImage.onerror = () => {
                    console.error("キャラクター画像の読み込みに失敗しました。ファイル名を確認してください。");
                    errorMessage.textContent = 'キャラクター画像 (pf-takasugi2.png) の読み込みに失敗しました。';
                    errorMessage.style.display = 'block';
                    loadingOverlay.style.display = 'none';
                };
            } else {
                startCamera();
            }
        };

    </script>
</body>
</html>