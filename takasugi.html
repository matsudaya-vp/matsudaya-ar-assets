<body>
    <video id="video-feed" autoplay playsinline></video>
    
    <img id="character-overlay" src="shinshaku_takasugi_1.png" alt="È´òÊùâÊôã‰Ωú">

    <!-- Êó•‰ªòË°®Á§∫„Ç®„É™„Ç¢ -->
    <div id="date-display"></div>

    <div id="ui-container">
        <button id="capture-button">üì∏ ÊíÆÂΩ±</button>
    </div>

    <script>
        const video = document.getElementById('video-feed');
        const captureButton = document.getElementById('capture-button');
        const characterOverlay = document.getElementById('character-overlay');
        const dateDisplay = document.getElementById('date-display');

        // ==== Êó•‰ªòË°®Á§∫ ====
        function updateDate() {
            const now = new Date();
            const y = now.getFullYear();
            const m = ('0' + (now.getMonth() + 1)).slice(-2);
            const d = ('0' + now.getDate()).slice(-2);
            dateDisplay.textContent = `${y}/${m}/${d}`;
        }
        updateDate(); // Ë™≠„ÅøËæº„ÅøÊôÇ„Å´‰∏ÄÂ∫¶„Å†„ÅëË°®Á§∫

        // ==== „Ç´„É°„É©Êò†ÂÉè„ÅÆÂèñÂæó ====
        if (navigator.mediaDevices && navigator.mediaDevices.getUserMedia) {
            navigator.mediaDevices.getUserMedia({ video: { facingMode: "environment" } })
                .then(stream => { video.srcObject = stream; })
                .catch(err => { alert('„Ç´„É°„É©„Å∏„ÅÆ„Ç¢„ÇØ„Çª„Çπ„ÅåÊãíÂê¶„Åï„Çå„Åæ„Åó„Åü: ' + err); });
        }
        
        // ==== ÊíÆÂΩ±Ê©üËÉΩ ====
        captureButton.addEventListener('click', () => {
            const w = video.videoWidth;
            const h = video.videoHeight;

            const canvas = document.createElement('canvas');
            canvas.width = w;
            canvas.height = h;
            const context = canvas.getContext('2d');

            // „Ç´„É°„É©Êò†ÂÉè
            context.save();
            context.scale(-1, 1);
            context.drawImage(video, -w, 0, w, h);
            context.restore();

            // „Ç≠„É£„É©„ÇØ„Çø„Éº
            const img = characterOverlay;
            const imgRatio = img.naturalHeight / img.naturalWidth;
            const cssVW = 0.7;
            const finalW = w * cssVW;
            const finalH = finalW * imgRatio;
            const finalX = (w - finalW) / 2;
            const finalY = (h - finalH) / 2;
            context.drawImage(img, finalX, finalY, finalW, finalH);

            // „Éï„Ç°„Ç§„É´ÂêçÁî®„ÅÆÊó•‰ªòÊôÇÂàª
            const now = new Date();
            const timestamp = now.getFullYear().toString()
                + ('0' + (now.getMonth() + 1)).slice(-2)
                + ('0' + now.getDate()).slice(-2) + '_'
                + ('0' + now.getHours()).slice(-2)
                + ('0' + now.getMinutes()).slice(-2)
                + ('0' + now.getSeconds()).slice(-2);

            const filename = `matsudaya_ar_photo_${timestamp}.png`;

            // „ÉÄ„Ç¶„É≥„É≠„Éº„Éâ
            const dataURL = canvas.toDataURL('image/png');
            const link = document.createElement('a');
            link.download = filename;
            link.href = dataURL;
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
        });
    </script>

    <style>
        /* Êó•‰ªòË°®Á§∫„ÅÆ„Éá„Ç∂„Ç§„É≥ */
        #date-display {
            position: fixed;
            top: 10px; 
            right: 10px;
            background: rgba(0,0,0,0.5);
            color: white;
            padding: 6px 12px;
            border-radius: 8px;
            font-family: sans-serif;
            font-size: 16px;
            z-index: 30;
        }
    </style>
</body>
